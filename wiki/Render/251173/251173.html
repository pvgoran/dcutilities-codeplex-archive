<div class="wikidoc"><h1>Route Helpers Tutorial</h1>This tutorial aims to illustrate the usage of the different utility methods provided in the RouteHelpers class in the DigitallyCreated.Utilities.Mvc assembly. It assumes knowledge of C# and ASP.NET MVC.<br />
<h2>RouteToCurrentPage</h2>Sometimes it&#39;s useful to get a RouteValueDictionary containing the necessary route values to generate a URL back to the current page. This includes any URL query parameters (ie <span class="codeInline">?param=value</span>). The RouteToCurrentPage extension method off of <a href="http://msdn.microsoft.com/en-us/library/system.web.mvc.urlhelper.aspx">UrlHelper</a> lets you do this. Here is an example of its use in a View:<br /><br /><div style="color:Black;background-color:White;"><pre>
<span style="background-color:Yellow;">&lt;%=</span> Html.RouteLink(<span style="color:#A31515;">&quot;Link to current page&quot;</span>, Url.RouteToCurrentPage()) <span style="background-color:Yellow;">%&gt;</span>
</pre></div>
<h2>Fluent Syntax Modification of RouteValueDictionary</h2>Sometimes you need to modify a RouteValueDictionary inline in an expression, especially when working with HtmlHelpers or UrlHelpers. The Include (alias of <a href="http://msdn.microsoft.com/en-us/library/system.web.routing.routevaluedictionary.add.aspx">Add</a>), Exclude (alias of <a href="http://msdn.microsoft.com/en-us/library/system.web.routing.routevaluedictionary.remove.aspx">Remove</a>) and Replace (alias for <a href="http://msdn.microsoft.com/en-us/library/system.web.routing.routevaluedictionary.item.aspx">the indexer</a>) let you do this, as they return the RouteValueDictionary, which allows you use chain up the method calls in the fluent syntax style.<br />Here&#39;s an example of their use:<br /><br /><div style="color:Black;background-color:White;"><pre>
<span style="background-color:Yellow;">&lt;%=</span> Html.RouteLink(<span style="color:#A31515;">&quot;Link to current page without sorting&quot;</span>, Url.RouteToCurrentPage().Exclude(<span style="color:#A31515;">&quot;sort&quot;</span>)) <span style="background-color:Yellow;">%&gt;</span>
</pre></div>
<h2>MapPhysicalToVirtualPath</h2>The MapPhysicalToVirtualPath extension method off of <a href="http://msdn.microsoft.com/en-us/library/system.web.httpserverutilitybase.aspx">HttpServerUtilityBase</a> (or <a href="http://msdn.microsoft.com/en-us/library/system.web.httpserverutility.aspx">HttpServerUtility</a>) lets you do the opposite of the <a href="http://msdn.microsoft.com/en-us/library/system.web.httpserverutilitybase.mappath.aspx">HttpServerUtilityBase.MapPath</a> method, namely get the virtual path for a file whose physical path you have.<br />Here&#39;s an example of its use:<br /><br /><div style="color:Black;background-color:White;"><pre>
<span style="color:Blue;">&lt;</span><span style="color:#A31515;">a</span> <span style="color:Red;">href</span><span style="color:Blue;">=</span><span style="color:Blue;">&quot;&lt;%= ResolveUrl(Context.Server.MapPhysicalToVirtualPath(Model.File.PhysicalPath)) %&gt;&quot;</span><span style="color:Blue;">&gt;</span>Download file<span style="color:Blue;">&lt;/</span><span style="color:#A31515;">a</span><span style="color:Blue;">&gt;</span>
</pre></div>
<h2>IsCurrentUserAuthorizedForRoute</h2><b>WARNING:</b> This method can be brittle as ASP.NET MVC doesn&#39;t really support the finding of an action method outside of an HTTP Request. This method mocks a fake request in order to determine authorization rights. If you get a NotImplementedException, you&#39;re probably doing something unexpected and unsupported with these mock request objects. In this case, you can either submit a patch to fix it, or stop using this method.<br />In addition, as the method effectively simulates a request in order to determine whether the user is authorized for that route, there may be a performance cost. This cost, whether it exists or not, has not been measured or tested and one should keep that in mind when choosing to invest in using this method. If in doubt, I personally suggest you don&#39;t use it.<br /><br />The IsCurrentUserAuthorizedForRoute allows you to specify access rights to various features once and for all as <a href="http://msdn.microsoft.com/en-us/library/system.web.mvc.authorizeattribute.aspx">Authorize</a> attributes on your Controller and its action methods. In your views, you may be doing something similar to this:<br /><br /><div style="color:Black;background-color:White;"><pre>
<span style="background-color:Yellow;">&lt;%</span> <span style="color:Blue;">if</span> (User.IsInRole(<span style="color:#A31515;">&quot;Administrator&quot;</span>)) { <span style="background-color:Yellow;">%&gt;</span>
    <span style="background-color:Yellow;">&lt;%=</span> Html.RouteLink(<span style="color:#A31515;">&quot;Admin Page&quot;</span>, <span style="color:Blue;">new</span> { controller = <span style="color:#A31515;">&quot;Admin&quot;</span>, action = <span style="color:#A31515;">&quot;Index&quot;</span> }) <span style="background-color:Yellow;">%&gt;</span>
<span style="background-color:Yellow;">&lt;%</span> } <span style="background-color:Yellow;">%&gt;</span>
</pre></div><br />You would also have the [Authorize(Roles=&quot;Administrator&quot;)] attribute on your action method/controller. However, if you want to change it so that the Developer role had access to the admin pages as well as the Administrator role, you&#39;d need up update not only the attributes on your action method/controller, but also the code in your views. The IsCurrentUserAuthorizedForRoute method lets you just specify your access rights on the controller/action method using attributes, and allows you to use that data from within your view, removing the need for encoding those access rights into your view logic.<br />Here&#39;s how you would use the method:<br /><br /><div style="color:Black;background-color:White;"><pre>
<span style="background-color:Yellow;">&lt;%</span> <span style="color:Blue;">if</span> (Url.IsCurrentUserAuthorizedForRoute(<span style="color:Blue;">new</span> { controller = <span style="color:#A31515;">&quot;Admin&quot;</span>, action = <span style="color:#A31515;">&quot;Index&quot;</span> }, HttpVerbs.Get)) { <span style="background-color:Yellow;">%&gt;</span>
    <span style="background-color:Yellow;">&lt;%=</span> Html.RouteLink(<span style="color:#A31515;">&quot;Admin Page&quot;</span>, <span style="color:Blue;">new</span> { controller = <span style="color:#A31515;">&quot;Admin&quot;</span>, action = <span style="color:#A31515;">&quot;Index&quot;</span> }) <span style="background-color:Yellow;">%&gt;</span>
<span style="background-color:Yellow;">&lt;%</span> } <span style="background-color:Yellow;">%&gt;</span>
</pre></div></div><div class="ClearBoth"></div>