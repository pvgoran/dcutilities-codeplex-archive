<div class="wikidoc"><h2>WCF Client Injection with Client Certificate from File Tutorial</h2>This tutorial aims to teach you how to use the WCF Client Injection extension to <a href="http://unity.codeplex.com/">Unity 1.2</a> (found in the DigitallyCreated.Utilities.Unity assembly) inject WCF clients that use a client certificate that was loaded from a file. It is assumed you are familiar with C#, WCF, Unity and the <a href="https://dcutilities.codeplex.com/wikipage?title=Basic%20WCF%20Channel%20Injection%20Tutorial&referringTitle=WCF%20Client%20Injection%20with%20Client%20Certificate%20from%20File%20Tutorial">previous tutorial</a>.<br /><br />There are some cases where you can&#39;t use WCF&#39;s configuration XML (<span class="codeInline">system.serviceModel</span>) to specify a client certificate to use in a binding configuration. The XML binding configuration only lets you specify details about the certificate to be pulled from the local system certificate store. The use case I came across was on ASP.NET shared hosting where you can&#39;t install arbitrary certificates in the certificate store, so I needed to load the certificate from a file on disk instead.<br /><br />Normally to load a certificate from a file on disk and use it in a binding configuration you&#39;d need to write your binding configuration in C# or write the majority of it in XML, then modify it in C# to provide the file-loaded certificate. Obviously, with dependency injection, you have no (or little) control over how the WCF client constructed and configured. <br /><br />In the <a href="https://dcutilities.codeplex.com/wikipage?title=Basic%20WCF%20Channel%20Injection%20Tutorial&referringTitle=WCF%20Client%20Injection%20with%20Client%20Certificate%20from%20File%20Tutorial">last tutorial</a>, the WCF Client Injection extension to Unity injected a WCF client for the IMyService interface. It did this by, behind the scenes, using a <a href="http://msdn.microsoft.com/en-us/library/ms576132.aspx">ChannelFactory&lt;T&gt;</a> to create a WCF client with specified endpoint configuration. The <span class="codeInline">ChannelFactory&lt;T&gt;</span> needs to be told up front at construction time the binding configuration to use. The WCF Client Injection extension to Unity abstracts away the construction of a <span class="codeInline">ChannelFactory&lt;T&gt;</span> behind the <span class="codeInline">IChannelFactoryFactory</span> interface. The concrete class <span class="codeInline">EndpointConfigurationChannelFactoryFactory</span> is used by default to create <span class="codeInline">ChannelFactory&lt;T&gt;</span>s.<br /><br />But in our case, where we want to customise the endpoint binding configuration with a file-loaded client certificate, the default <span class="codeInline">IChannelFactoryFactory</span> isn&#39;t cutting it. Thankfully, there is a way to choose a different <span class="codeInline">IChannelFactoryFactory</span> to use. DigitallyCreated.Utilities.Unity contains another <span class="codeInline">IChannelFactoryFactory</span> that will allow us to use a file-loaded client certificates: the <span class="codeInline">ClientCertificateFromFileChannelFactoryFactory</span>. (And in the same fashion, if you need to do something that isn&#39;t supported by any of the out of the box <span class="codeInline">IChannelFactoryFactory</span>s, you can create your own and use it).<br /><br />So, to use the <span class="codeInline">ClientCertificateFromFileChannelFactoryFactory</span>, we need to customise the <span class="codeInline">serviceInterface</span> XML element we used in the <a href="https://dcutilities.codeplex.com/wikipage?title=Basic%20WCF%20Channel%20Injection%20Tutorial&referringTitle=WCF%20Client%20Injection%20with%20Client%20Certificate%20from%20File%20Tutorial">last tutorial</a>:<br /><br /><div style="color:Black;background-color:White;"><pre>
<span style="color:Blue;">&lt;</span><span style="color:#A31515;">serviceInterface</span> <span style="color:Red;">type</span><span style="color:Blue;">=</span><span style="color:Black;">&quot;</span><span style="color:Blue;">MyServices.IMyService, MyServicesAssembly</span><span style="color:Black;">&quot;</span><span style="color:Blue;">&gt;</span>
    &lt;customChannelFactoryFactory 
        cfgElementType=&quot;DigitallyCreated.Utilities.Unity.Configuration.ClientCertificateFromFileChannelFactoryFactoryConfElement, DigitallyCreated.Utilities.Unity&quot;
        endpointConfiguration=&quot;MyServiceEndpoint&quot;
        certFilename=&quot;~\ServiceClientCertificate.pfx&quot;
        certPassword=&quot;&quot; /&gt;
<span style="color:Blue;">&lt;/</span><span style="color:#A31515;">serviceInterface</span><span style="color:Blue;">&gt;</span>
</pre></div><br />Note that our <span class="codeInline">serviceInterface</span> element now contains a <span class="codeInline">customChannelFactoryFactory</span> element. The <span class="codeInline">cfgElementType</span> attribute specifies the .NET class to use to deserialize the custom configuration element (in this case, for the <span class="codeInline">ClientCertificateFromFileChannelFactoryFactory</span>, its the hugely named <span class="codeInline">ClientCertificateFromFileChannelFactoryFactoryConfElement</span>). Notice the endpoint configuration&#39;s name has shifted from the <span class="codeInline">serviceInterface</span> element to the <span class="codeInline">customChannelFactoryFactory</span>. This is because using the <span class="codeInline">endpointConfiguration</span> attribute on the <span class="codeInline">serviceInterface</span> element is just shorthand for telling the extension to use the default <span class="codeInline">EndpointConfigurationChannelFactoryFactory</span>. The certificate&#39;s filename is specified in <span class="codeInline">certFilename</span> and the password to access it is specified in <span class="codeInline">certPassword</span>.<br /><br />And that&#39;s it. That custom configuration element class will take care of wiring in the use of the <span class="codeInline">ClientCertificateFromFileChannelFactoryFactory</span>.</div><div class="ClearBoth"></div>